<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capture Cam</title>

    <!-- <link rel="stylesheet" href="css/camera.css"> -->


    <style>
        h1 {
            margin: 0 0 24px 0;
        }
        
        select {
            width: 150px;
        }
        
        video,
        canvas {
            position: absolute;
            /* margin: 10px 0 0 0; */
            /* width: 320;
            height: 240; */
        }
    </style>

</head>

<body>
    <div id="container">
        <button id="snap">Snap Photo</button>
        <button id="snapStop">Stop Snap </button>

        <!-- <div class="select">
            <label for="videoSource">Select Camera: </label><select id="videoSource"></select>
        </div> -->
        <video id="video" autoplay muted playsinline width="320" height="240"></video>

        <canvas id="myCanvas" width="320" height="240"> </canvas>
        <canvas id="canvas" width="320" height="240"> </canvas>

    </div>

    <script>
        var startSnap = false;
        var videoElement = document.getElementById('video');
        // var videoSelect = document.querySelector('select#videoSource');

        // videoSelect.onchange = stream;


        navigator.mediaDevices.enumerateDevices().then((devices) => {
            devices = devices.filter((d) => d.kind === 'videoinput');
            console.log(devices)

            navigator.mediaDevices.getUserMedia({
                audio: true,
                video: {
                    deviceId: devices[0].deviceId
                }
            }).then((stream) => {
                videoElement.srcObject = stream;

            }).catch((err) => {
                // if (err ==
                //     "NotAllowedError: The request is not allowd by the user agent or the platform in the current context, possibly because the user denied permission."
                // ) {
                //     alert("カメラ")
                // } else {
                //     alert(err)
                // }
                alert(err)
            })
        });



        // videoSelect.onchange = getStream;
        // getStream().then(getDevices).then(gotDevices);

        // function getDevices() {
        //     // AFAICT in Safari this only gets default devices until gUM is called :/
        //     return navigator.mediaDevices.enumerateDevices();
        // }

        // function gotDevices(deviceInfos) {
        //     window.deviceInfos = deviceInfos; // make available to console
        //     // console.log('Available input and output devices:', deviceInfos);
        //     for (const deviceInfo of deviceInfos) {
        //         const option = document.createElement('option');
        //         option.value = deviceInfo.deviceId;
        //         // if (deviceInfo.kind === 'audioinput') {
        //         //     option.text = deviceInfo.label || `Microphone ${audioSelect.length + 1}`;
        //         //     audioSelect.appendChild(option);
        //         // } else 
        //         if (deviceInfo.kind === 'videoinput') {
        //             option.text = deviceInfo.label || `Camera ${videoSelect.length + 1}`;
        //             videoSelect.appendChild(option);
        //         }
        //     }
        // }

        // function getStream() {
        //     if (window.stream) {
        //         window.stream.getTracks().forEach(track => {
        //             track.stop();
        //         });
        //     }
        //     // const audioSource = audioSelect.value;
        //     const videoSource = videoSelect.value;
        //     const constraints = {
        //         // audio: {
        //         //     deviceId: audioSource ? {
        //         //         exact: audioSource
        //         //     } : undefined
        //         // },
        //         video: {
        //             deviceId: videoSource ? {
        //                 exact: videoSource
        //             } : undefined
        //         }
        //     };
        //     return navigator.mediaDevices.getUserMedia(constraints).
        //     then(gotStream).catch(handleError);
        // }

        // function gotStream(stream) {
        //     window.stream = stream; // make stream available to console
        //     // audioSelect.selectedIndex = [...audioSelect.options].
        //     // findIndex(option => option.text === stream.getAudioTracks()[0].label);
        //     videoSelect.selectedIndex = [...videoSelect.options].
        //     findIndex(option => option.text === stream.getVideoTracks()[0].label);
        //     videoElement.srcObject = stream;
        // }

        // function handleError(error) {
        //     console.error('Error: ', error);
        // }

        // Elements for taking the snapshot

        var c = document.getElementById('canvas');
        var ctx = c.getContext('2d');

        function rectMake() {

            if (startSnap == true) {
                ctx.strokeStyle = "blue";


                ctx.drawImage(videoElement, 0, 0, 640, 480, 0, 0, 96, 126);
                ctx.strokeRect(70, 70, 160, 120);

                ctx.strokeStyle = "gray"
                ctx.moveTo(0, 120); // Begin first sub-path
                ctx.lineTo(320, 120);
                ctx.moveTo(160, 0); // Begin second sub-path
                ctx.lineTo(160, 240);
                ctx.stroke();
            }

        }


        // Trigger photo take
        document.getElementById("snap").addEventListener("click", function() {
            // draw a white background
            startSnap = true;
            setInterval(() => {

                rectMake()

            }, 1);



        });
        document.getElementById("snapStop").addEventListener("click", function() {
            // draw a white background
            startSnap = false
            ctx.clearRect(0, 0, c.width, c.height);
        });
    </script>
</body>


</html>